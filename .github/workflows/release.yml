# CockpitOS Release â€” Package and publish
# Triggered via: python release.py (or manually from Actions tab)
# The workflow creates the tag, builds the zip, and publishes the release.
name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 1.1.5)'
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Validate version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Invalid version format: $VERSION (expected: 1.2.3)"
            exit 1
          fi
          if git tag -l "v${VERSION}" | grep -q .; then
            echo "::error::Tag v${VERSION} already exists"
            exit 1
          fi

      - name: Find previous release tag
        id: prev
        run: |
          PREV=$(git tag -l | while read t; do
            ver="${t#v}"
            echo "$ver $t"
          done | sort -t. -k1,1n -k2,2n -k3,3n | tail -1 | awk '{print $2}')

          echo "tag=$PREV" >> "$GITHUB_OUTPUT"
          echo "Previous tag: $PREV"

      - name: Generate changelog
        run: |
          VERSION="${{ github.event.inputs.version }}"
          PREV="${{ steps.prev.outputs.tag }}"
          REPO_URL="https://github.com/${{ github.repository }}"

          if [ -n "$PREV" ]; then
            git log "${PREV}..HEAD" --no-merges --format="- %s ([%h](${REPO_URL}/commit/%H))" | head -100 > changelog.md
            echo "" >> changelog.md
            echo "**Full Changelog**: [${PREV}...v${VERSION}](${REPO_URL}/compare/${PREV}...v${VERSION})" >> changelog.md
          else
            git log --no-merges --format="- %s ([%h](${REPO_URL}/commit/%H))" | head -50 > changelog.md
          fi

      - name: Package CockpitOS.zip
        run: |
          zip -r CockpitOS.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x ".claude/*" \
            -x ".vs/*" \
            -x "__pycache__/*" \
            -x "build/*" \
            -x "Dev/*" \
            -x "nul" \
            -x "*.lock" \
            -x "Debug Tools/logs/*" \
            -x "src/Core/Private/*" \
            -x "Disabled Panels/*" \
            -x "Binaries/Unclassified/*" \
            -x "compiler/backups/*" \
            -x "compiler/__pycache__/*" \
            -x "compiler/*.lock" \
            -x "HID Manager/__pycache__/*" \
            -x "label_creator/__pycache__/*" \
            -x ".credentials/*" \
            -x "CLAUDE.md" \
            -x "TODO.md" \
            -x "TODO/*"

      - name: Create tag and publish release
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TAG="v${VERSION}"

          git tag "$TAG"
          git push origin "$TAG"

          gh release create "$TAG" \
            --title "CockpitOS v${VERSION}" \
            --notes-file changelog.md \
            --latest \
            CockpitOS.zip
        env:
          GH_TOKEN: ${{ github.token }}
