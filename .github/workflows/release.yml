# CockpitOS Release â€” Package and publish on version tag
# Triggers when a tag like v1.2.3 is pushed (manually or via GitHub UI)
name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history needed for changelog generation

      - name: Get version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Find previous release tag
        id: prev
        run: |
          CURRENT="${{ steps.version.outputs.tag }}"
          CURRENT_VER="${CURRENT#v}"
          REPO_URL="https://github.com/${{ github.repository }}"

          # Get ALL tags (with and without v prefix), normalize to version numbers,
          # sort by version, find the one right before current
          PREV=$(git tag -l | while read t; do
            ver="${t#v}"
            echo "$ver $t"
          done | sort -t. -k1,1n -k2,2n -k3,3n | awk -v cur="$CURRENT_VER" '{
            if ($1 == cur) { print prev; exit }
            prev = $2
          }')

          echo "tag=$PREV" >> "$GITHUB_OUTPUT"
          echo "Previous tag: $PREV"

      - name: Generate changelog
        id: changelog
        run: |
          PREV="${{ steps.prev.outputs.tag }}"
          CURRENT="${{ steps.version.outputs.tag }}"
          REPO_URL="https://github.com/${{ github.repository }}"

          {
            echo 'body<<CHANGELOG_EOF'
            echo "## What's Changed"
            echo ""
            if [ -n "$PREV" ]; then
              # List commits since previous tag, skip merge commits, include SHA links
              git log "${PREV}..${CURRENT}" --no-merges --format="- %s ([%h](${REPO_URL}/commit/%H))" | head -100
              echo ""
              echo "**Full Changelog**: [${PREV}...${CURRENT}](${REPO_URL}/compare/${PREV}...${CURRENT})"
            else
              git log --no-merges --format="- %s ([%h](${REPO_URL}/commit/%H))" | head -50
            fi
            echo 'CHANGELOG_EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Package CockpitOS.zip
        run: |
          zip -r CockpitOS.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x ".claude/*" \
            -x ".vs/*" \
            -x "__pycache__/*" \
            -x "build/*" \
            -x "Dev/*" \
            -x "nul" \
            -x "*.lock" \
            -x "Debug Tools/logs/*" \
            -x "src/Core/Private/*" \
            -x "Disabled Panels/*" \
            -x "Binaries/Unclassified/*" \
            -x "compiler/backups/*" \
            -x "compiler/__pycache__/*" \
            -x "compiler/*.lock" \
            -x "HID Manager/__pycache__/*" \
            -x "label_creator/__pycache__/*" \
            -x ".credentials/*" \
            -x "CLAUDE.md" \
            -x "TODO.md" \
            -x "TODO/*"

      - name: Delete existing release if present
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          # Delete the release (but keep the tag) so we can recreate it with assets
          gh release delete "$TAG" --yes 2>/dev/null || true
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: CockpitOS v${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.body }}
          files: CockpitOS.zip
          make_latest: true
