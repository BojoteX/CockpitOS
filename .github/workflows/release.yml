# CockpitOS Release — Package and publish on version tag
# To release: merge PR to main, then push a tag:
#   git checkout main && git pull
#   git tag v1.2.3
#   git push origin v1.2.3
# Do NOT create releases from the GitHub UI — this workflow handles everything.
name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Find previous release tag
        id: prev
        run: |
          CURRENT="${{ steps.version.outputs.tag }}"
          CURRENT_VER="${CURRENT#v}"

          PREV=$(git tag -l | while read t; do
            ver="${t#v}"
            echo "$ver $t"
          done | sort -t. -k1,1n -k2,2n -k3,3n | awk -v cur="$CURRENT_VER" '{
            if ($1 == cur) { print prev; exit }
            prev = $2
          }')

          echo "tag=$PREV" >> "$GITHUB_OUTPUT"
          echo "Previous tag: $PREV"

      - name: Generate changelog
        run: |
          PREV="${{ steps.prev.outputs.tag }}"
          CURRENT="${{ steps.version.outputs.tag }}"
          REPO_URL="https://github.com/${{ github.repository }}"

          if [ -n "$PREV" ]; then
            git log "${PREV}..${CURRENT}" --no-merges --format="- %s ([%h](${REPO_URL}/commit/%H))" | head -100 > changelog.md
            echo "" >> changelog.md
            echo "**Full Changelog**: [${PREV}...${CURRENT}](${REPO_URL}/compare/${PREV}...${CURRENT})" >> changelog.md
          else
            git log --no-merges --format="- %s ([%h](${REPO_URL}/commit/%H))" | head -50 > changelog.md
          fi

      - name: Package CockpitOS.zip
        run: |
          zip -r CockpitOS.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x ".claude/*" \
            -x ".vs/*" \
            -x "__pycache__/*" \
            -x "build/*" \
            -x "Dev/*" \
            -x "nul" \
            -x "*.lock" \
            -x "Debug Tools/logs/*" \
            -x "src/Core/Private/*" \
            -x "Disabled Panels/*" \
            -x "Binaries/Unclassified/*" \
            -x "compiler/backups/*" \
            -x "compiler/__pycache__/*" \
            -x "compiler/*.lock" \
            -x "HID Manager/__pycache__/*" \
            -x "label_creator/__pycache__/*" \
            -x ".credentials/*" \
            -x "CLAUDE.md" \
            -x "TODO.md" \
            -x "TODO/*"

      - name: Publish release
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            --title "CockpitOS v${{ steps.version.outputs.version }}" \
            --notes-file changelog.md \
            --latest \
            CockpitOS.zip
        env:
          GH_TOKEN: ${{ github.token }}
